<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
<title>Disaster Mapper Submit</title>
<meta http-equiv="Content-Language" content="en-us" />
<meta name="author" content="Your Name Goes Here" />

<!-- <style type="text/css" media="all"> -->

<link href="css/style.css" rel="stylesheet" type="text/css" media="screen" />
<link href="css/displaypage.css" rel="stylesheet" type="text/css" media="screen" />
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css' /> <!-- Font link -->
	<link href="images/favicon.png" rel="shortcut icon"  type="image/x-icon">

</style>
   <script type="text/javascript" src="http://www.google.com/jsapi?key=ABQIAAAAZBe7uHI90ESk2XAmWRL3RxR6u04U0tImA3bfwZ3-HKdEno7z2xRk2YE6OkudtBX5qy0vLrgbf1DUCg"></script>
		<script type="text/javascript">
			google.load("jquery", '1.2.6');
			google.load("maps", "2.x");
		</script>
</head>

<body>
<!--  Page content goes here -->

<div id="wrapper">

	<div id="top">
	
		<div id="logo">
			<p class="logo">
			<a href="displaypage.html">
			<img class="logo" src="images/logo1.png" alt="Loco Logo" width="100px" height="100px"/>
			</a>
			</p> 
		<h1> Disaster Mapper</h1>
		</div>

	<div id="topnav" class="wrap">
	<ul id="nav">
		<li><a href="displaypage.html">Map</a></li>
		<li><a href="submitpage.html">Submit a Picture</a></li>
        <li><a href="about.html">About</a>
        <!--	<ul>
            <li><a href="#">Hardware</a></li>
            <li><a href="#">Software</a></li>
            <li><a href="#">Accessories</a></li>
            <li><a href="#">Reviews</a></li>
			<li><a href="#">Community</a></li>
            </ul> USE THIS LIST IF YOU WANT A DROPDOWN MENU-->
        </li>

	</ul>
	</div>
	
	</div>
</div> <!-- end of wrapper div-->
<div id="content-wrapper">
		
	<div id="content">
	<center><h1> The Disaster Map </h1></center>
	
		<div id="mapleftside">
		
		<!--Map Code Starts -->
		<script type="text/javascript" charset="utf-8">
			$(function(){
				var map = new GMap2(document.getElementById('map'));
				var burnsvilleMN = new GLatLng(44.797916,-93.278046);
				map.setCenter(burnsvilleMN, 8);
				var bounds = new GLatLngBounds();
				var geo = new GClientGeocoder(); 
				
				var reasons=[];
				reasons[G_GEO_SUCCESS]            = "Success";
				reasons[G_GEO_MISSING_ADDRESS]    = "Missing Address";
				reasons[G_GEO_UNKNOWN_ADDRESS]    = "Unknown Address.";
				reasons[G_GEO_UNAVAILABLE_ADDRESS]= "Unavailable Address";
				reasons[G_GEO_BAD_KEY]            = "Bad API Key";
				reasons[G_GEO_TOO_MANY_QUERIES]   = "Too Many Queries";
				reasons[G_GEO_SERVER_ERROR]       = "Server error";
				
				// initial load points
				$.getJSON("php/map-service.php?action=listpoints", function(json) {
					if (json.Locations.length > 0) {
						for (i=0; i<json.Locations.length; i++) {
							var location = json.Locations[i];
							addLocation(location);
						}
						zoomToBounds();
					}
				});
				
				$("#add-point").submit(function(){
					geoEncode();
					return false;
				});
				
				function savePoint(geocode) {
					var data = $("#add-point :input").serializeArray();
					data[data.length] = { name: "lng", value: geocode[0] };
					data[data.length] = { name: "lat", value: geocode[1] };
					$.post($("#add-point").attr('action'), data, function(json){
						$("#add-point .error").fadeOut();
						if (json.status == "fail") {
							$("#add-point .error").html(json.message).fadeIn();
						}
						if (json.status == "success") {
							$("#add-point :input[name!=action]").val("");
							var location = json.data;
							addLocation(location);
							zoomToBounds();
						}
					}, "json");
				}
				
				function geoEncode() {
					var address = $("#add-point input[name=address]").val();
					geo.getLocations(address, function (result){
						if (result.Status.code == G_GEO_SUCCESS) {
							geocode = result.Placemark[0].Point.coordinates;
							savePoint(geocode);
						} else {
							var reason="Code "+result.Status.code;
							if (reasons[result.Status.code]) {
								reason = reasons[result.Status.code]
							} 
							$("#add-point .error").html(reason).fadeIn();
							geocode = false;
						}
					});
				}
				
				function addLocation(location) {
					var point = new GLatLng(location.lat, location.lng);		
					var marker = new GMarker(point);
					map.addOverlay(marker);
					bounds.extend(marker.getPoint());
					
					$("<li />")
						.html(location.name)
						.click(function(){
							showMessage(marker, location.name);
						})
						.appendTo("#list");
					
					GEvent.addListener(marker, "click", function(){
						showMessage(this, location.name);
					});
				}
				
				function zoomToBounds() {
					map.setCenter(bounds.getCenter());
					map.setZoom(map.getBoundsZoomLevel(bounds)-1);
				}
				
				$("#message").appendTo( map.getPane(G_MAP_FLOAT_SHADOW_PANE) );
				
				function showMessage(marker, text){
					var markerOffset = map.fromLatLngToDivPixel(marker.getPoint());
					$("#message").hide().fadeIn()
						.css({ top:markerOffset.y, left:markerOffset.x })
						.html(text);
				}
			});
		</script>
	</head>
	<body>
		<div id="map"></div>
		<ul id="list"></ul>
		<div id="message"></div>
		</div>
		
		<!-- Map Code Ends -->
		<div id="maprightside">
			<br/>
			<div id="info">
			<p> This is a placeholder </p>
			</div>
			
			<div id="submissionButton">
				<center><a href="submitpage.html">Submit Your Own Image</a></center>
			</div>
		</div>
	
    </div>
</div> <!--  end of content-wrapper div -->
</body>

</html>
